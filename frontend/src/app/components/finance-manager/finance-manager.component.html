<div class="finance-container fade-in">
  <header>
    <h1>üè¶ Personal Finance</h1>
    <div class="sub-nav">
      <button [class.active-tab]="incomeSubView === 'expenses'" (click)="incomeSubView = 'expenses'">Expenses</button>
      <button [class.active-tab]="incomeSubView === 'income'" (click)="incomeSubView = 'income'">Income</button>
      <button [class.active-tab]="incomeSubView === 'transactions'" (click)="incomeSubView = 'transactions'">Transactions</button>
      <button [class.active-tab]="incomeSubView === 'autoearn'" (click)="incomeSubView = 'autoearn'">AutoEarn</button>
      <button [class.active-tab]="incomeSubView === 'stats'" (click)="incomeSubView = 'stats'">Statistics</button>
    </div>
    <p class="subtitle">Manage and track your bank transactions</p>
  </header>

  <div class="stats-grid">
    <div class="card stat-box">
      <label>Total Income</label>
      <p class="stat-value" style="color: #28a745;">+${{ totalIncome | number:'1.2-2' }}</p>
    </div>
    <div class="card stat-box">
      <label>Total Expenses</label>
      <p class="stat-value" style="color: #ff4444;">-${{ totalExpenses | number:'1.2-2' }}</p>
    </div>
    <div class="card stat-box">
      <label>Net Cash Flow</label>
      <p class="stat-value" [style.color]="totalNetBalance >= 0 ? '#fff' : '#ff4444'">
        ${{ totalNetBalance | number:'1.2-2' }}
      </p>
    </div>
    <div class="card stat-box">
      <label>Capital One</label>
      <p class="stat-value" style="color: #007bff; font-size: 1.1rem;">${{ capitalOneBalance | number:'1.2-2' }}</p>
    </div>
    <div class="card stat-box">
      <label>Santander</label>
      <p class="stat-value" style="color: #ec0000; font-size: 1.1rem;">${{ santanderBalance | number:'1.2-2' }}</p>
    </div>
  </div>

  <app-financial-goals 
    [goals]="goals" 
    (addGoal)="onAddGoal($event)"
    (updateGoal)="onUpdateGoal($event)"
    (deleteGoal)="onDeleteGoal($event)">
  </app-financial-goals>

  @if (incomeSubView === 'expenses') {
    <div class="fade-in">
      <section class="card finance-form-card">
        <h3>Log New Transaction</h3>
        <div class="finance-form-grid">
          <div class="form-group"><label>Date</label><input type="date" #fDate [value]="today"></div>
          <div class="form-group">
            <label>Bank</label>
            <select #fBank>
              <option value="Capital One">Capital One</option>
              <option value="Santander">Santander</option>
            </select>
          </div>
          <div class="form-group"><label>Amount</label><input type="number" #fAmount placeholder="0.00" step="0.01"></div>
          <div class="form-group">
            <label>Category</label>
            <select #fCategory>
              <option value="Dining">Dining</option>
              <option value="Merchandise">Merchandise</option>
              <option value="Gas/Automotive">Gas/Automotive</option>
              <option value="Bill">Bill</option>
            </select>
          </div>
          <div class="form-group full-width"><label>Description</label><input type="text" #fDesc placeholder="Weekly Groceries"></div>
        </div>
        <button class="primary-btn submit-finance" (click)="onAddExpense({date: fDate.value, bank: fBank.value, amount: fAmount.value, category: fCategory.value, description: fDesc.value})">Add Transaction</button>
      </section>

      <section class="card finance-history-card">
        <h3>Recent Transactions</h3>
        <table>
          <thead>
            <tr><th>Date</th><th>Source</th><th>Category</th><th>Note</th><th style="text-align: right;">Amount</th><th style="text-align: center;">Action</th></tr>
          </thead>
          <tbody>
            @for (item of allFinance; track item._id) {
              <tr>
                <td>{{ item.date }}</td>
                <td><span class="badge" [style.background]="item.bank === 'Capital One' ? '#003a70' : '#ec0000'">{{ item.bank }}</span></td>
                <td>{{ item.category }}</td>
                <td style="color: #aaa;">{{ item.description }}</td>
                <td style="text-align: right; font-weight: bold;">${{ item.amount | number:'1.2-2' }}</td>
                <td style="text-align: center;"><button class="row-delete-btn" (click)="onDeleteExpense(item._id)">üóëÔ∏è</button></td>
              </tr>
            }
          </tbody>
        </table>
      </section>
    </div>
  }

  @if (incomeSubView === 'income') {
    <div class="fade-in">
      <section class="card finance-form-card">
        <h3>Log Income / Cash Flow</h3>
        <div class="finance-form-grid">
          <div class="form-group"><label>Date</label><input type="date" #iDate [value]="today"></div>
          <div class="form-group">
            <label>Source</label>
            <select #iSource>
              <option value="Salary">Salary</option>
              <option value="Dividends">Dividends</option>
              <option value="Freelance">Freelance</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group"><label>Amount</label><input type="number" #iAmount placeholder="0.00"></div>
          <div class="form-group full-width"><label>Note</label><input type="text" #iNote placeholder="Monthly Paycheck"></div>
        </div>
        <button class="primary-btn" style="background: #28a745; width: 100%;" 
          (click)="onAddIncome({date: iDate.value, source: iSource.value, amount: iAmount.value, note: iNote.value}); iAmount.value=''; iNote.value=''">
          Log Income
        </button>
      </section>

      <section class="card finance-history-card">
        <h3>Income History</h3>
        <table>
          <thead>
            <tr><th>Date</th><th>Source</th><th>Note</th><th style="text-align: right;">Amount</th><th style="text-align: center;">Action</th></tr>
          </thead>
          <tbody>
            @for (inc of allIncome; track inc._id) {
              <tr>
                <td>{{ inc.date }}</td>
                <td><span class="badge" style="background: #28a745;">{{ inc.source }}</span></td>
                <td style="color: #aaa;">{{ inc.note }}</td>
                <td style="text-align: right; color: #28a745; font-weight: bold;">+${{ inc.amount | number:'1.2-2' }}</td>
                <td style="text-align: center;">
                  <button class="row-delete-btn" (click)="onDeleteIncome(inc._id)">üóëÔ∏è</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </section>
    </div>
  }

  @if (incomeSubView === 'transactions') {
    <section class="card finance-history-card fade-in">
      <h3>All Ledger Transactions</h3>
      <p style="color: #666; font-size: 0.8rem; margin-bottom: 10px;">
        Showing {{ allTransactions.length }} total entries found in database.
      </p>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Source</th>
            <th>Note/Category</th>
            <th style="text-align: right;">Amount</th>
          </tr>
        </thead>
        <tbody>
          @for (tx of allTransactions; track (tx._id || tx.date + tx.amount)) {
            <tr>
              <td>{{ tx.date || 'No Date' }}</td>
              <td>
                <span [style.color]="tx.isNegative ? '#ff4444' : '#28a745'" style="font-weight: 500;">
                  {{ tx.txType }}
                </span>
              </td>
              <td>{{ tx.displaySource }}</td>
              <td style="color: #aaa;">{{ tx.displayNote }}</td>
              <td style="text-align: right; font-weight: bold;" 
                  [style.color]="tx.isNegative ? '#fff' : '#28a745'">
                {{ tx.isNegative ? '-' : '+' }}${{ (tx.amount || 0) | number:'1.2-2' }}
              </td>
            </tr>
          }
        </tbody>
      </table>
    </section>
  }

@if (incomeSubView === 'autoearn') {
    <div class="autoearn-view fade-in">
      
      <div class="card" style="background: linear-gradient(45deg, #1a1a1a, #004085); margin-bottom: 20px;">
        <label style="color: #ccc; font-size: 0.9rem;">Total Earned This Year</label>
        <h2 style="font-size: 2.5rem; margin: 10px 0; color: white;">${{ yearlyTotal | number:'1.2-2' }}</h2>
      </div>

      <section class="card">
        <h3>Log Earnings</h3>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <input type="text" #monthLabel placeholder="Label (e.g. Jan Total)" style="flex: 1; padding: 12px; background: #000; border: 1px solid #333; color: white; border-radius: 4px;">
          <input type="number" #amountVal placeholder="Amount $" style="flex: 1; padding: 12px; background: #000; border: 1px solid #333; color: white; border-radius: 4px;">
          <button class="primary-btn" (click)="onAddTotal(monthLabel.value, amountVal.value); monthLabel.value=''; amountVal.value=''">Save Entry</button>
        </div>
      </section>

      <section class="card" style="margin-top: 20px;">
        <h3>Earnings History</h3>
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
          <thead>
            <tr style="text-align: left; color: #888; font-size: 0.8rem; border-bottom: 1px solid #333;">
              <th style="padding: 10px;">Description</th>
              <th style="text-align: right;">Amount</th>
              <th style="text-align: right;">Action</th>
            </tr>
          </thead>
          <tbody>
            @for (item of allEarnings; track item._id) {
  <tr style="border-bottom: 1px solid #1a1a1a;">
    @if (editingId === item._id) {
      <td style="padding: 10px;">
        <input type="text" #editLabel [value]="item.platform" style="width: 90%; padding: 8px; background: #000; border: 1px solid #444; color: white;">
      </td>
      <td style="text-align: right; padding: 10px;">
        <input type="number" #editAmount [value]="item.amount" style="width: 100px; padding: 8px; background: #000; border: 1px solid #444; color: white;">
      </td>
      <td style="text-align: right;">
        <button (click)="saveEdit(item, editLabel.value, editAmount.value)" style="color: #28a745; background: none; border: none; cursor: pointer; margin-right: 10px;">Save</button>
        <button (click)="cancelEdit()" style="color: #888; background: none; border: none; cursor: pointer;">Cancel</button>
      </td>
    } @else {
      <td style="padding: 15px; color: #eee;">{{ item.platform }}</td>
      <td style="text-align: right; color: #28a745; font-weight: bold; font-size: 1.1rem;">
        +${{ item.amount | number:'1.2-2' }}
      </td>
      <td style="text-align: right;">
        <button (click)="startEdit(item)" style="background: none; border: none; color: #007bff; cursor: pointer; margin-right: 10px;">Edit</button>
        <button (click)="deleteAutoEarnEvent.emit(item._id)" style="background: none; border: none; color: #666; cursor: pointer;">Remove</button>
      </td>
    }
  </tr>
}
          </tbody>
        </table>
      </section>
    </div>
  }

  @if (incomeSubView === 'stats') {
  <div class="stats-container fade-in" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    
    <section class="card statistics-card">
      <h3>Monthly Cash Flow Summary</h3>
      <table>
        <thead>
          <tr>
        <th>Month</th>
        <th>Income</th>
        <th>Expenses</th>
        <th>Net (Saved)</th>
        <th>% Saved</th> 
      </tr>
        </thead>
        <tbody>
      <tr *ngFor="let s of getMonthlySummary()">
        <td>{{ s.month }}</td>
        <td>{{ s.income | currency }}</td>
        <td>{{ s.expenses | currency }}</td>
        <td [style.color]="s.net >= 0 ? 'green' : 'red'">{{ s.net | currency }}</td>
        <td>{{ s.percentSaved }}%</td> </tr>
    </tbody>
        <tbody>
          @for (stat of monthlyStats; track stat.month) {
            <tr>
              <td>{{ stat.month }}</td>
              <td style="text-align: right; color: #ff4444;">-${{ stat.spent | number:'1.2-2' }}</td>
              <td style="text-align: right;" [style.color]="(stat.earned - stat.spent) >= 0 ? '#28a745' : '#ff4444'">
                ${{ (stat.earned - stat.spent) | number:'1.2-2' }}
              </td>
            </tr>
          }
        </tbody>
      </table>
    </section>

    <section class="card statistics-card">
      <h3>Spending by Category</h3>
      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th style="text-align: right;">Total Amount</th>
            <th style="text-align: right;">% of Total</th>
          </tr>
        </thead>
        <tbody>
          @for (cat of categoryStats; track cat.name) {
            <tr>
              <td style="font-weight: bold; color: #fff;">{{ cat.name }}</td>
              <td style="text-align: right; color: #ff4444;">-${{ cat.total | number:'1.2-2' }}</td>
              <td style="text-align: right; color: #666;">
                {{ (cat.total / totalExpenses * 100) | number:'1.1-1' }}%
              </td>
            </tr>
          }
        </tbody>
      </table>
    </section>
  </div>
}
</div>