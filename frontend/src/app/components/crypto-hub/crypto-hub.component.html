<div class="crypto-container fade-in">
  <header>
    <h1>üí∞ Crypto Trading Hub</h1>
    <div class="sub-nav">
      <button [class.active-tab]="cryptoSubView === 'log'" (click)="cryptoSubView = 'log'">Trade Logger</button>
      <button [class.active-tab]="cryptoSubView === 'stats'" (click)="cryptoSubView = 'stats'">Analytics</button>
      <button [class.active-tab]="cryptoSubView === 'backtest'" (click)="cryptoSubView = 'backtest'">Backtesting</button>
    </div>
  </header>

  @if (cryptoSubView === 'log') {
    <div class="fade-in">
      <section class="card trade-form-card">
  <h3>Log New Professional Trade</h3>
  
  <div class="trade-form-grid">
    <div class="form-group"><label>Date</label><input type="date" #fDate></div>
    <div class="form-group"><label>Asset</label><input type="text" #fAsset placeholder="BTC"></div>
    <div class="form-group">
      <label>Action</label>
      <select #fAction><option value="Long">Long</option><option value="Short">Short</option></select>
    </div>
    <div class="form-group"><label>Amount</label><input type="number" #fAmount></div>
    <div class="form-group"><label>Price</label><input type="number" #fPrice></div>
    <div class="form-group"><label>Strategy</label><input type="text" #fStrategy></div>
    <div class="form-group"><label>R-Multiple</label><input type="number" #fRMult></div>
    <div class="form-group"><label>Purple Belt</label><input type="checkbox" #fPurple></div>
    <div class="form-group"><label>Platform</label><input type="text" #fPlatform></div>
    <div class="form-group">
      <label>Order Type</label>
      <select #fOrderType><option value="Market">Market</option><option value="Limit">Limit</option></select>
    </div>
    <div class="form-group"><label>SL</label><input type="number" #fSL></div>
    <div class="form-group"><label>Exit Price</label><input type="number" #fExitPrice></div>
    <div class="form-group"><label>Entry Time</label><input type="time" #fEntryTime></div>
    <div class="form-group"><label>Exit Date</label><input type="date" #fExitDate></div>
    <div class="form-group"><label>Exit Time</label><input type="time" #fExitTime></div>
    <div class="form-group"><label>Risk $</label><input type="number" #fRisk></div>
    <div class="form-group"><label>Exp. Loss</label><input type="number" #fExpLoss></div>
    <div class="form-group"><label>Realised Loss</label><input type="number" #fRealLoss></div>
    <div class="form-group"><label>Realised Gain</label><input type="number" #fRealGain></div>
    <div class="form-group">
      <label>Chart</label>
      <input type="file" (change)="onFileSelected($event)">
    </div>
  </div>

  <button class="primary-btn" (click)="addTrade(
    fDate, fAsset, fAction, fAmount, fPrice, fStrategy, fRMult, fPurple, 
    fPlatform, fOrderType, fSL, fExitPrice, fEntryTime, fExitDate, fExitTime, 
    fRisk, fExpLoss, fRealLoss, fRealGain
  )">Log Trade</button>
</section>

      <section class="card table-card">
        <table>
          <thead>
            <tr>
              <th (click)="toggleDateSort()" style="cursor: pointer;">Date {{ sortOrder === 'desc' ? '‚Üì' : '‚Üë' }}</th>
              <th>Asset</th><th>Action</th><th>Order</th><th>Strategy</th><th>Price</th><th>SL</th><th>Risk</th><th>R-Mult</th><th>Result ($)</th><th>Proof</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (record of allTrades; track record._id) {
              <tr [class.editing-row]="editingTradeId === record._id">
                @if (editingTradeId === record._id) {
                   } @else {
                  <td>{{ record.date }}</td>
                  <td><span *ngIf="record.purpleBelt">üü£ </span><strong>{{ record.asset }}</strong></td>
                  <td><span [class]="record.action">{{ record.action }}</span></td>
                  <td>{{ record.orderType }}</td>
                  <td>{{ record.strategy }}</td>
                  <td>{{ record.price | number:'1.2-2' }}</td>
                  <td>{{ record.stopLoss | number:'1.2-2' }}</td>
                  <td>${{ record.riskAmount }}</td>
                  <td>{{ record.rMultiple }}R</td>
                  <td>
                    @if (record.realisedGains > 0) {
                      <span class="Win">+$ {{ record.realisedGains | number:'1.2-2' }}</span>
                    } @else if (record.realisedLoss > 0) {
                      <span class="Loss">-$ {{ record.realisedLoss | number:'1.2-2' }}</span>
                    } @else {
                      <span class="Pending">{{ record.result || 'Pending' }}</span>
                    }
                  </td>
                  
                  <td>
                    @if (record.image) {
                      <button (click)="openChart(record.image)" class="view-chart-btn">üñºÔ∏è View</button>
                    } @else {
                      <span style="color: #666;">-</span>
                    }
                  </td>
                  
                  <td><button (click)="startEdit(record)">‚úèÔ∏è</button><button (click)="onDeleteTrade(record._id)" class="del-btn">üóëÔ∏è</button></td>
                }
              </tr>
            }
          </tbody>
        </table>
      </section>
    </div>
  }

  @if (cryptoSubView === 'stats') {
  <div class="analytics-dashboard fade-in">
    
    <div class="stats-summary-grid">
      <div class="card stat-card">
        <label>System Expectancy</label>
        <div class="value" [style.color]="expectancy > 0 ? '#28a745' : '#ff4444'">
          {{ expectancy | number:'1.2-2' }}R
        </div>
        <small>Profit per trade in R</small>
      </div>

      <div class="card stat-card">
        <label>Avg. R-Multiple</label>
        <div class="value">{{ avgR | number:'1.2-2' }}R</div>
        <small>Across {{ allTrades.length }} trades</small>
      </div>

      <div class="card stat-card">
        <label>Purple Belt (Discipline)</label>
        <div class="value" style="color: #a333c8;">{{ purpleWinRate | number:'1.1-1' }}%</div>
        <small>Win rate when following rules</small>
      </div>

      <div class="card stat-card">
        <label>Standard Win Rate</label>
        <div class="value">{{ standardWinRate | number:'1.1-1' }}%</div>
        <small>Win rate on standard setups</small>
      </div>
    </div>

    <div class="card strategy-section">
      <h3>Strategy Performance Breakdown</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Strategy</th>
              <th class="text-center">Trades</th>
              <th class="text-center">Win Rate</th>
              <th class="text-center">Expectancy</th>
              <th class="text-right">Net Profit</th>
            </tr>
          </thead>
          <tbody>
            @for (strat of strategyStats; track strat.name) {
              <tr>
                <td><strong>{{ strat.name }}</strong></td>
                <td class="text-center">{{ strat.count }}</td>
                <td class="text-center">{{ strat.winRate | number:'1.1-1' }}%</td>
                <td class="text-center" [style.color]="strat.expectancy > 0 ? '#28a745' : '#ff4444'">
                  {{ strat.expectancy | number:'1.2-2' }}R
                </td>
                <td class="text-right" [style.color]="strat.profit >= 0 ? '#28a745' : '#ff4444'">
                  {{ strat.profit >= 0 ? '+' : '' }}{{ strat.profit | currency }}
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
      <div class="card" style="margin-top: 20px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="color: #2196f3; margin: 0;">Monthly Performance</h3>
    <span style="font-size: 0.8rem; color: #888;">Track your progress over time</span>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Month</th>
          <th class="text-center">Total Trades</th>
          <th class="text-center">Win Rate</th>
          <th class="text-right">Net P&L</th>
        </tr>
      </thead>
      <tbody>
        @for (m of monthlyPerformance; track m.month) {
          <tr>
            <td><strong>{{ m.month }}</strong></td>
            <td class="text-center">{{ m.count }}</td>
            <td class="text-center">
               <span [style.color]="m.winRate >= 50 ? '#28a745' : '#ff4444'">
                 {{ m.winRate | number:'1.0-0' }}%
               </span>
            </td>
            <td class="text-right" [style.color]="m.profit >= 0 ? '#28a745' : '#ff4444'">
              {{ m.profit >= 0 ? '+' : '' }}{{ m.profit | currency }}
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>
    </div>

  </div>
}

  @if (cryptoSubView === 'backtest') {
    <div class="backtest-layout fade-in">
      <section class="card backtest-form">
        <h3>New Backtest Entry</h3>
        <div class="trade-form-grid">
          <div class="form-group"><label>Asset</label><input #bAsset type="text" placeholder="BTCUSD"></div>
          <div class="form-group"><label>Date</label><input #bDate type="date"></div>
          <div class="form-group"><label>Entry</label><input #bEntry type="number"></div>
          <div class="form-group"><label>SL</label><input #bSl type="number"></div>
          <div class="form-group"><label>Exit</label><input #bExit type="number"></div>
          <div class="form-group">
            <label>Chart</label>
            <input type="file" (change)="onFileSelected($event)">
          </div>
        </div>
        <button class="primary-btn" style="margin-top: 15px; width: 100%;" 
                (click)="onSaveBacktest(bAsset, bDate, bEntry, bSl, bExit)">
          Save Results
        </button>
      </section>

      <section class="card backtest-history">
        <div class="backtest-header">
          <h3>Backtest History ({{ backtests.length }})</h3>
          <div class="expectancy-badge" 
         [style.background]="backtestExpectancy >= 0 ? 'rgba(40, 167, 69, 0.1)' : 'rgba(255, 68, 68, 0.1)'"
         [style.color]="backtestExpectancy >= 0 ? '#28a745' : '#ff4444'"
         style="padding: 8px 15px; border-radius: 6px; border: 1px solid currentColor; font-weight: bold;">
      Expectancy: {{ backtestExpectancy | number:'1.2-2' }}R
    </div>
          </div>
        <table>
          <thead>
            <tr>
              <th>Asset</th>
              <th>Date</th>
              <th>Direction</th>
              <th>Returns</th>
              <th>Result</th>
              <th>Chart</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (bt of backtests; track bt._id) {
              <tr>
                <td>{{ bt.asset }}</td>
                <td>{{ bt.date | date:'shortDate' }}</td>
                <td>{{ bt.direction }}</td>
                <td>{{ bt.returns | number:'1.1-2' }}R</td>
                <td>{{ bt.result }}</td>
                <td>
                  @if (bt.image) {
                    <button (click)="openChart(bt.image)" class="view-chart-btn">üñºÔ∏è Chart</button>
                  } @else {
                    <span style="color: #666;">None</span>
                  }
                </td>
                <td><button (click)="deleteBacktest(bt._id)">üóëÔ∏è</button></td>
              </tr>
            }
          </tbody>
        </table>
      </section>
    </div>
  }
</div>